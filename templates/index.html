<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
  <title>Bootstrap demo</title>
</head>

<body>
  <div class="container">
    <div class="row">
      {% if user.is_authenticated %}
      <h1>Already logged in<h1>
      {%else%}
      <h1>Haven't logged in<h1>
      {% endif %}
      <h1>Hello, world!</h1>
      <button type="button" class="col-3 btn btn-primary" onclick="deleteToken()">Refresh</button>
    </div>
    <div class="row">
      <div class="col-5" id="messages" name="messages"></div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
</body>

</html>


<!-- Firebase JS -->
<script src="https://www.gstatic.com/firebasejs/4.1.2/firebase.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
  crossorigin="anonymous"></script>
<script>
  // Initialize Firebase
  // Firebase Console --> Settings --> General
  // --> Register App --> Copy firebaseConfig
  const firebaseConfig = {
    apiKey: "AIzaSyBzeD9ynJq4ad6Tj0hGDZJozANfcwyKbsQ",
    authDomain: "djangomesseging.firebaseapp.com",
    projectId: "djangomesseging",
    storageBucket: "djangomesseging.appspot.com",
    messagingSenderId: "152529043805",
    appId: "1:152529043805:web:b927b52304fa86cf50a8b4",
    measurementId: "G-13X9HCQ07F"
  };

  firebase.initializeApp(firebaseConfig);

  // Firebase Messaging Service
  const messaging = firebase.messaging();

  // Send the Instance ID token your application server, so that it can:
  // - send messages back to this app
  // - subscribe/unsubscribe the token from topics

  function test(){
    $.ajax({
      url: "http://localhost:8000/user/1/",
      method: "GET",
      async: false,
      dataType: 'JSON',
      {% comment %}data: {
        token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzA2MTk3NzM5LCJpYXQiOjE2OTc1NTc3MzksImp0aSI6ImYxMjA4MzFjMzllODRhYmViMDY4OTA4ODI5YzFlNTk0IiwidXNlcl9pZCI6MX0.qZzd-F9TkCI8n8TjhRJD39qC3yWYM_LUrBb3oRo0AHc"
      },{% endcomment %}
      headers: {
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzA2MTk3NzM5LCJpYXQiOjE2OTc1NTc3MzksImp0aSI6ImYxMjA4MzFjMzllODRhYmViMDY4OTA4ODI5YzFlNTk0IiwidXNlcl9pZCI6MX0.qZzd-F9TkCI8n8TjhRJD39qC3yWYM_LUrBb3oRo0AHc'
      },
      success: function (data) {
        console.log(data);
      },
      error: function (err) {
        console.log(err);
      }
    });
  }

  test();
  function sendTokenToServer(currentToken) {
    if (!isTokenSentToServer()) {
      // The API Endpoint will be explained at step 8
      $.ajax({
        url: "http://localhost:8000/api/devices/",
        method: "POST",
        async: false,
        dataType: 'JSON',
        data: {
          // Add the csrf_token auth to avoid "403 forbidden" error.
          //'csrfmiddlewaretoken': "{{ csrf_token }}",
          'registration_id': currentToken,
          'type': 'web', 
        },
        headers: {
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzA2MTk3NzM5LCJpYXQiOjE2OTc1NTc3MzksImp0aSI6ImYxMjA4MzFjMzllODRhYmViMDY4OTA4ODI5YzFlNTk0IiwidXNlcl9pZCI6MX0.qZzd-F9TkCI8n8TjhRJD39qC3yWYM_LUrBb3oRo0AHc'
          
        },
        success: function (data) {
          console.log(data);
          setTokenSentToServer(true);
        },
        error: function (err) {
          console.log(err);
          setTokenSentToServer(false);
        }
      });
    } else {
      console.log('Token already sent to server so won\'t send it again ' +
        'unless it changes');
    }
  }

  function isTokenSentToServer() {
    return window.localStorage.getItem("sentToServer") === "1";
  }

  function setTokenSentToServer(sent) {
    if (sent) {
      window.localStorage.setItem("sentToServer", "1");
    } else {
      window.localStorage.setItem("sentToServer", "0");
    }
  }


  function requestPermission() {
    messaging.requestPermission().then(function () {
      console.log("Has permission!");
      resetUI();
    }).catch(function (err) {
      console.log('Unable to get permission to notify.', err);
    });
  }

  function resetUI() {
    console.log("In reset ui");
    messaging.getToken().then(function (currentToken) {
      console.log(currentToken);
      if (currentToken) {
        sendTokenToServer(currentToken);
      } else {
        setTokenSentToServer(false);
      }
    }).catch(function (err) {
      console.log(err);
      setTokenSentToServer(false);
    });
  }

  messaging.onTokenRefresh(function () {
    messaging.getToken().then(function (refreshedToken) {
      console.log("Token refreshed.");
      // Indicate that the new Instance ID token has not yet been sent to the
      // app server.
      setTokenSentToServer(false);
      // Send Instance ID token to app server.
      sendTokenToServer(refreshedToken);
      resetUI();
    }).catch(function (err) {
      console.log("Unable to retrieve refreshed token ", err);
    });
  });


  messaging.onMessage(function (payload) {
    console.log("Messages Coming!", payload)
    payload = payload.data;

    // Create notification manually when user is focused on the tab
    const notificationTitle = payload.title;
    const notificationOptions = {
      body: payload.body,
      icon: payload.icon_url,
    };

    if (!("Notification" in window)) {
      console.log("This browser does not support system notifications");
    }
    // Let's check whether notification permissions have already been granted
    else if (Notification.permission === "granted") {
      console.log("Notifaction is permitted.")
      // If it's okay let's create a notification
      var notification = new Notification(notificationTitle, notificationOptions);
      notification.onclick = function (event) {
        event.preventDefault(); // prevent the browser from focusing the Notification's tab
        window.open(payload.url, '_blank');
        notification.close();
      }
    }
    else {
      console.log("Something goes wrong.")
    }
  });

  // Delete instant VAPID
  function deleteToken() {
    // Delete Instance ID token.
    // [START delete_token]
    messaging.getToken()
      .then(function (currentToken) {
        messaging.deleteToken(currentToken)
          .then(function () {
            console.log('Token deleted.');
            setTokenSentToServer(false);
            // [START_EXCLUDE]
            // Once token is deleted update UI.
            resetUI();
            // [END_EXCLUDE]
          })
          .catch(function (err) {
            console.log('Unable to delete token. ', err);
          });
        // [END delete_token]
      })
      .catch(function (err) {
        console.log('Error retrieving Instance ID token. ', err);
        showToken('Error retrieving Instance ID token. ', err);
      });

  }


  requestPermission();
</script>